<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eventos - Eventim</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <style>
    .card-img-top {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }
    .card-link {
      text-decoration: none;
      color: inherit;
    }
    .header {
      background-color: black;
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 2em;
      margin-bottom: 20px;
    }
    .card-text {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    @media (max-width: 767px) {
      .card-img-top {
        height: 200px;
      }
    }
    @media (min-width: 768px) and (max-width: 991px) {
      .card-img-top {
        height: 150px;
      }
    }
    @media (min-width: 992px) {
      .card-img-top {
        height: 150px;
      }
    }
  </style>
</head>
<body>
  <div class="header">Shows e Eventos em Jo√£o Pessoa - Eventim</div>
  <div class="container">
    <div id="eventos" class="row"></div>
    <button id="loadMore" class="btn btn-primary" style="display: none; margin: 0 auto;">Mais Eventos</button>
  </div>
  <script>
    // const url = 'https://www.eventim.com.br/city/joao-pessoa-1816/';
    // const PROXY_URL = 'https://cors-anywhere.herokuapp.com/';
    const url = 'https://cors-eventim.mosaicoworkers.workers.dev/api/city/joao-pessoa-1816/';
    let eventosCount = 0;

    function loadEvents() {
      fetch(url) 
        .then(response => response.text())
        .then(html => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const eventosDiv = document.getElementById('eventos');

          const eventos = doc.querySelectorAll('product-group-item');

          eventos.forEach((evento, index) => {
  if (index >= eventosCount && index < eventosCount + 9) {
    try {
      const script = evento.querySelector('script[type="application/ld+json"]');
      const data = JSON.parse(script.textContent);

      const nome = data['name'];
      const startDate = data['startDate']; // Get startDate here

      const startDateObj = new Date(startDate); // Create startDateObj inside the loop

      // Options for formatting (adjust as needed)
      const options = {
  weekday: 'short',
  day: 'numeric',
  month: 'numeric', // Use 'numeric' to display month as 08
  year: 'numeric',
  hour: 'numeric',
  minute: 'numeric',
  timeZone: 'America/Sao_Paulo'
};

                
    const formattedStartDate = startDateObj.toLocaleDateString('pt-BR', options);

                const local = data['location']['address']['addressLocality'];
                
                const foto = data['image'][0];
                const link = data['url'];

                const eventoDiv = document.createElement('div');
                eventoDiv.className = 'col-md-4 col-sm-6 mb-4';
                eventoDiv.innerHTML = `
                  <div class="card">
                    <a href="${link}" target="_blank" class="card-link">
                      <img src="${foto}" class="card-img-top" alt="${nome}">
                    </a>
                    <div class="card-body">
                      <h6 class="card-subtitle mb-2 text-muted">Fonte: Eventim</h6>
                      <h5 class="card-title">${nome}</h5>
                      <p class="card-text">${formattedStartDate}</p>
                      <p class="card-text">${local}</p>
                    </div>
                  </div><br>
                `;
                eventosDiv.appendChild(eventoDiv);
              } catch (error) {
                console.error(`Erro ao processar o evento: ${error}`);
              }
            }
          });

          eventosCount += 9;
          if (eventosCount < eventos.length) {
            document.querySelector("#loadMore").style.display = 'block';
          } else {
            document.querySelector("#loadMore").style.display = 'none';
          }
        })
        .catch(console.error);
    }

    document.querySelector("#loadMore").addEventListener('click', loadEvents);
    loadEvents();
  </script>
</body>
</html>
