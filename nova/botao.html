<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultas de Clima e Mar√©s com Gemini</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            line-height: 1.6;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 40px auto;
            text-align: center;
        }
        .buttons-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 25px;
            font-size: 16px;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
            margin: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #climaBtn {
            background-color: #007bff;
        }
        #climaBtn:hover {
            background-color: #0056b3;
        }
        #maresBtn {
            background-color: #17a2b8;
        }
        #maresBtn:hover {
            background-color: #138496;
        }
        #resultado {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #e9ecef;
            min-height: 50px;
            text-align: left;
        }
        .loading {
            font-style: italic;
            color: #555;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .button-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        #speakBtn {
            background-color: #28a745;
        }
        #speakBtn:hover {
            background-color: #218838;
        }
        #stopSpeakBtn {
            background-color: #dc3545;
        }
        #stopSpeakBtn:hover {
            background-color: #c82333;
        }
        .audio-controls {
            margin-top: 15px;
            display: none;
        }
        /* √çcones embutidos como Unicode */
        .icon {
            font-size: 1.2em;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Consultas com Gemini</h1>
    <p>Clique em um dos bot√µes para obter um resumo gerado pelo Gemini sobre o clima ou as mar√©s em Jo√£o Pessoa.</p>

    <div class="buttons-container">
        <button id="climaBtn"><span class="icon">üå§Ô∏è</span> Ver Clima Atual</button>
        <button id="maresBtn"><span class="icon">üåä</span> Ver Mar√©s Atuais</button>
    </div>

    <div id="resultado">
        Clique em um dos bot√µes acima para ver o resultado.
    </div>

    <div class="audio-controls" id="audioControls">
        <div class="button-container">
            <button id="speakBtn" title="Ouvir resumo"><span class="icon">üîä</span> Ouvir</button>
            <button id="stopSpeakBtn" title="Parar √°udio"><span class="icon">üõë</span> Parar</button>
        </div>
    </div>
</div>

<script>
    // --- Configura√ß√£o ---
    const WEATHER_API_URL = 'https://clima.mosaicoworkers.workers.dev/';
    const TIDES_API_URL = 'https://mares.mosaicoworkers.workers.dev/';
    
    // !!! CUIDADO EXTREMO: NUNCA coloque sua chave de API diretamente no c√≥digo frontend em produ√ß√£o !!!
    //     Isto √© APENAS para teste local e demonstra√ß√£o. Qualquer pessoa pode ver esta chave.
    //     Para produ√ß√£o, use um backend para proteger sua chave.
    const GEMINI_API_KEY = "AIzaSyAQR7qRaUJ6wpEq_RrGSUzodbkmVbz7Gdk"; // <= SUBSTITUA PELA SUA CHAVE
    const GEMINI_MODEL_ID = "gemini-1.5-flash-latest"; // Modelo a ser usado
    const GEMINI_API_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/";

    // --- Elementos DOM ---
    const climaButton = document.getElementById('climaBtn');
    const maresButton = document.getElementById('maresBtn');
    const resultadoDiv = document.getElementById('resultado');
    const speakButton = document.getElementById('speakBtn');
    const stopSpeakButton = document.getElementById('stopSpeakBtn');
    const audioControls = document.getElementById('audioControls');

    // --- Vari√°veis globais ---
    let currentText = '';
    let isSpeaking = false;

    // --- Verificar suporte √† s√≠ntese de voz ---
    const speechSynthesisSupported = 'speechSynthesis' in window;
    
    // --- Configura√ß√£o de s√≠ntese de voz ---
    let synth = window.speechSynthesis;
    let utterance = null;

    // --- Fun√ß√µes para controle de voz ---
    function speakText(text) {
        if (!speechSynthesisSupported) {
            alert('Seu navegador n√£o suporta s√≠ntese de voz.');
            return;
        }
        
        // Parar qualquer fala em andamento
        if (synth.speaking) {
            synth.cancel();
        }
        
        // Criar nova inst√¢ncia de fala
        utterance = new SpeechSynthesisUtterance(text);
        
        // Configurar voz em portugu√™s
        utterance.lang = 'pt-BR';
        
        // Eventos
        utterance.onstart = function() {
            isSpeaking = true;
            speakButton.disabled = true;
        };
        
        utterance.onend = function() {
            isSpeaking = false;
            speakButton.disabled = false;
        };
        
        utterance.onerror = function(event) {
            console.error('Erro de s√≠ntese de voz:', event);
            isSpeaking = false;
            speakButton.disabled = false;
        };
        
        // Iniciar fala
        synth.speak(utterance);
    }
    
    function stopSpeaking() {
        if (speechSynthesisSupported && synth.speaking) {
            synth.cancel();
            isSpeaking = false;
            speakButton.disabled = false;
        }
    }

    // --- Fun√ß√£o para buscar dados e gerar resumo com Gemini ---
    async function consultarGemini(apiUrl, promptGenerator) {
        // 1. Desabilitar bot√µes e mostrar loading
        climaButton.disabled = true;
        maresButton.disabled = true;
        resultadoDiv.innerHTML = '<div class="loading">Buscando dados...</div>';
        
        // Esconder controles de √°udio enquanto carrega novos dados
        audioControls.style.display = 'none';
        
        // Parar qualquer fala em andamento
        stopSpeaking();

        try {
            // 2. Buscar dados da API
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`Erro ao buscar dados: ${response.status} ${response.statusText}`);
            }
            const dados = await response.json();
            resultadoDiv.innerHTML = '<div class="loading">Dados obtidos. Solicitando resumo ao Gemini...</div>';

            // 3. Construir o Prompt para o Gemini usando a fun√ß√£o geradora de prompt
            const promptParaGemini = promptGenerator(dados);

            // 4. Preparar a Requisi√ß√£o para o Gemini
            const geminiUrl = `${GEMINI_API_BASE_URL}${GEMINI_MODEL_ID}:generateContent?key=${GEMINI_API_KEY}`;
            const requestBody = {
                contents: [{
                    role: 'user',
                    parts: [{ text: promptParaGemini }]
                }],
                // Opcional: Adicionar safetySettings ou generationConfig se necess√°rio
                // safetySettings: [ ... ],
                // generationConfig: { temperature: 0.7, ... }
            };

            // 5. Chamar a API do Gemini
            const responseGemini = await fetch(geminiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!responseGemini.ok) {
                let errorMsg = `Erro na API do Gemini: ${responseGemini.status} ${responseGemini.statusText}`;
                try {
                    const errorData = await responseGemini.json();
                    errorMsg += ` - ${errorData.error?.message ?? 'Detalhes indispon√≠veis'}`;
                } catch (parseError) { /* Ignora erro de parse do erro */ }
                throw new Error(errorMsg);
            }

            const dadosGemini = await responseGemini.json();

            // 6. Extrair e exibir o resultado
            const textoGerado = dadosGemini?.candidates?.[0]?.content?.parts?.[0]?.text;

            if (textoGerado) {
                resultadoDiv.textContent = textoGerado; // Usar textContent para seguran√ßa
                currentText = textoGerado; // Armazenar o texto para uso com o sistema de voz
                
                // Mostrar controles de √°udio se a s√≠ntese de voz for suportada
                if (speechSynthesisSupported) {
                    audioControls.style.display = 'block';
                }
            } else {
                // Lidar com casos onde a resposta √© v√°lida mas n√£o tem texto (ex: bloqueado)
                const blockReason = dadosGemini?.promptFeedback?.blockReason;
                if (blockReason) {
                    resultadoDiv.innerHTML = `<div class="error">Conte√∫do bloqueado pela API do Gemini. Motivo: ${blockReason}</div>`;
                } else {
                    resultadoDiv.innerHTML = `<div class="error">Resposta inesperada da API do Gemini. Nenhum texto gerado.</div>`;
                    console.warn("Resposta Gemini inesperada:", dadosGemini);
                }
                
                // Esconder controles de √°udio se n√£o houver texto para falar
                audioControls.style.display = 'none';
            }

        } catch (error) {
            console.error("Erro:", error);
            resultadoDiv.innerHTML = `<div class="error">Falha: ${error.message}</div>`;
            audioControls.style.display = 'none'; // Esconder controles de √°udio em caso de erro
        } finally {
            // 7. Reabilitar os bot√µes
            climaButton.disabled = false;
            maresButton.disabled = false;
        }
    }

    // --- Fun√ß√£o para gerar o prompt de clima ---
    function gerarPromptClima(dados) {
        const temp = dados.current?.temperature ?? 'N/A';
        const desc = dados.current?.weather_description ?? 'N/A';
        const uv = dados.air_quality?.uv_category ?? 'N/A';
        const aqi = dados.air_quality?.aqi_category ?? 'N/A';

        return `Com base nos seguintes dados meteorol√≥gicos atuais para Jo√£o Pessoa: 
        Temperatura=${temp}¬∞C, 
        Condi√ß√£o='${desc}', 
        √çndice UV='${uv}', 
        Qualidade do Ar='${aqi}'. 
        
        Por favor, gere um resumo conciso e em linguagem natural para um usu√°rio. 
        Comece com "A temperatura atual em Jo√£o Pessoa √© de..." e inclua uma recomenda√ß√£o 
        baseada nas condi√ß√µes atuais (se deve usar protetor solar, levar guarda-chuva, etc.).`;
    }

    // --- Fun√ß√£o para gerar o prompt de mar√©s ---
    function gerarPromptMares(dados) {
        const nivelAtual = dados.current?.level.toFixed(2) ?? 'N/A';
        
        // Encontra a pr√≥xima mar√©
        let proximaMare = "n√£o dispon√≠vel";
        let tipoProximaMare = "";
        
        // Organiza todas as mar√©s por dia e hor√°rio
        const hoje = dados.current?.date;
        if (hoje && dados.tidesByDay && dados.tidesByDay[hoje]) {
            const maresDoDia = [...dados.tidesByDay[hoje]];
            maresDoDia.sort((a, b) => a.time.localeCompare(b.time));
            
            // Encontra a pr√≥xima mar√© ap√≥s a hora atual
            const horaAtual = dados.current?.time;
            const proximaMareDoDia = maresDoDia.find(mare => mare.time > horaAtual);
            
            if (proximaMareDoDia) {
                proximaMare = `${proximaMareDoDia.time} com altura de ${proximaMareDoDia.height}`;
                tipoProximaMare = proximaMareDoDia.high ? "alta" : "baixa";
            }
        }
        
        // Fase da lua
        const faseLua = dados.moon?.simplified ?? "n√£o dispon√≠vel";
        
        return `Com base nos seguintes dados de mar√©s para Jo√£o Pessoa:
        N√≠vel atual da mar√©: ${nivelAtual} metros
        Pr√≥xima mar√© ${tipoProximaMare}: ${proximaMare}
        Fase da Lua: ${faseLua}
        
        Por favor, gere um resumo conciso em linguagem natural para um usu√°rio sobre as 
        condi√ß√µes atuais das mar√©s. Inclua uma recomenda√ß√£o baseada no n√≠vel atual e na 
        previs√£o da pr√≥xima mar√© (se √© bom para nadar, pescar, etc.). 
        Comece com "O n√≠vel atual da mar√© em Jo√£o Pessoa √© de..." e explique de forma 
        simples o que isso significa para atividades na praia.`;
    }

    // --- Fun√ß√µes espec√≠ficas para cada bot√£o ---
    async function obterResumoClima() {
        await consultarGemini(WEATHER_API_URL, gerarPromptClima);
    }
    
    async function obterResumoMares() {
        await consultarGemini(TIDES_API_URL, gerarPromptMares);
    }

    // --- Adicionar Event Listeners ---
    climaButton.addEventListener('click', obterResumoClima);
    maresButton.addEventListener('click', obterResumoMares);
    
    // Event Listeners para controles de √°udio
    speakButton.addEventListener('click', function() {
        if (currentText) {
            speakText(currentText);
        }
    });
    
    stopSpeakButton.addEventListener('click', stopSpeaking);

    // Limpar a fala ao sair da p√°gina
    window.addEventListener('beforeunload', function() {
        if (speechSynthesisSupported && synth.speaking) {
            synth.cancel();
        }
    });
</script>

</body>
</html>