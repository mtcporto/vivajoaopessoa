<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Alertas meteorológicos</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <style>
        .card {
            flex: 0 0 auto;
            margin: 10px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
            transition: 0.3s;
        }
        .card:hover {
            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <header class="bg-dark text-white p-3 text-center"><h1>Alertas meteorológicos</h1></header>
    <div id="localizacao" class="container mt-3"></div>
    <div class="container mt-3">
        <h2>Pesquisar por cidade/estado</h2>
        <form id="pesquisaForm">
            <div class="form-group">
                <label for="cidade">Cidade:</label>
                <input type="text" class="form-control" id="cidade" placeholder="Digite a cidade">
            </div>
            <div class="form-group">
                <label for="estado">Estado:</label>
                <input type="text" class="form-control" id="estado" placeholder="Digite o estado">
            </div>
            <button type="submit" class="btn btn-primary">Pesquisar</button>
        </form>
    </div>
    <div id="avisos" class="container mt-3 d-flex flex-wrap justify-content-center"></div>

    <script>
        $(document).ready(function() {
            var estados = {};
            var cidadeUsuario, estadoUsuario;

            function obterLocalizacao(latitude, longitude) {
                var url = 'https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=' + latitude + '&lon=' + longitude;

                $.getJSON(url, function(data) {
                    if (data.address) {
                        cidadeUsuario = data.address.city || data.address.town || data.address.village;
                        estadoUsuario = data.address.state;

                        $('#localizacao').html('<h2>Sua Localização</h2><p>' + cidadeUsuario + ', ' + estadoUsuario + '</p>');

                        // Após obter a localização, consultar os alertas
                        consultarAlertas(cidadeUsuario, estadoUsuario);
                    } else {
                        console.log('Erro ao obter localização');
                    }
                });
            }

            function consultarAlertas(cidade, estado) {
                $.get('https://apiprevmet3.inmet.gov.br/avisos/rss', function(data) {
                    $(data).find("item").each(function() {
                        var el = $(this);
                        var link = el.find("link").text();
                        $.get(link, function(alertData) {
                            var alertEl = $(alertData);
                            var inicio = new Date(alertEl.find('onset').text().replace('T', ' ').replace(/-/g, '/'));
                            var fim = new Date(alertEl.find('expires').text().replace('T', ' ').replace(/-/g, '/'));
                            var agora = new Date();

                            if (inicio <= agora && fim >= agora) {
                                var aviso = alertEl.find('event').text();
                                var severidade = alertEl.find('severity').text();
                                var colorRisk = alertEl.find('parameter valueName:contains("ColorRisk")').next().text();
                                var estadoAlerta = alertEl.find('parameter valueName:contains("Estados")').next().text();
                                var cidadeAlerta = alertEl.find('parameter valueName:contains("Municipios")').next().text();

                                if (!estados[estadoAlerta]) {
                                    estados[estadoAlerta] = [];
                                }
                                estados[estadoAlerta].push({ aviso, severidade, inicio, fim, cidadeAlerta, colorRisk });

                                var avisoHtml = '<div class="card mb-3 d-none">';
                                avisoHtml += '<div class="card-header" style="background-color:' + colorRisk + ';"><strong>' + aviso + '</strong></div>';
                                avisoHtml += '<div class="card-body">';
                                avisoHtml += '<p><strong>Severidade:</strong> ' + severidade + '</p>';
                                avisoHtml += '<p><strong>Início:</strong> ' + inicio.toLocaleString('pt-BR') + '</p>';
                                avisoHtml += '<p><strong>Fim:</strong> ' + fim.toLocaleString('pt-BR') + '</p>';
                                avisoHtml += '<p><strong>Cidade:</strong> ' + cidadeAlerta + '</p>';
                                avisoHtml += '<p><strong>Estado:</strong> ' + estadoAlerta + '</p>';
                                avisoHtml += '</div></div>';

                                $('#avisos').append(avisoHtml);
                            }
                        });
                    });
                }).fail(function() {
                    console.log('Erro ao consultar alertas');
                });
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude;
                    var lon = position.coords.longitude;
                    obterLocalizacao(lat, lon);
                }, function() {
                    console.log('Erro ao obter localização');
                });
            } else {
                console.log('Geolocalização não é suportada por este navegador.');
            }

            // Função para filtrar os cards com base na cidade e estado inseridos no formulário de pesquisa
            $('#pesquisaForm').submit(function(event) {
                event.preventDefault();

                var cidadePesquisada = $('#cidade').val().trim().toLowerCase();
                var estadoPesquisado = $('#estado').val().trim().toLowerCase();

                // Limpar avisos anteriores
                $('#avisos').empty();

                // Consultar os alertas com base na cidade e estado pesquisados
                consultarAlertas(cidadePesquisada, estadoPesquisado);
            });
        });
    </script>
</body>
</html>
