<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>WebTorrent video player</title>
    <style>
      #output video {
        width: 100%;
      }
      #progressBar {
          height: 5px;
          width: 0%;
          background-color: #35b44f;
          transition: width .4s ease-in-out;
      }
      body.is-seed .show-seed {
          display: inline;
      }
      body.is-seed .show-leech {
          display: none;
      }
      .show-seed {
          display: none;
      }
      #status code {
          font-size: 90%;
          font-weight: 700;
          margin-left: 3px;
          margin-right: 3px;
          border-bottom: 1px dashed rgba(255,255,255,0.3);
      }

      .is-seed #hero {
          background-color: #154820;
          transition: .5s .5s background-color ease-in-out;
      }
      #hero {
          background-color: #2a3749;
      }
      #status {
          color: #fff;
          font-size: 17px;
          padding: 5px;
      }
      a:link, a:visited {
          color: #30a247;
          text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div id="hero">
      <div id="output">
        <div id="progressBar"></div>
        <!-- The video player will be added here -->
      </div>
      <!-- Statistics -->
      <div id="status">
        <div>
          <span class="show-leech">Downloading </span>
          <span class="show-seed">Seeding </span>
          <code>
        <!-- Informative link to the torrent file -->
        <a id="torrentLink" href="https://nyaa.si/download/1807247.torrent">[Erai-raws] One Piece - 1101 [480p] [ENG].torrent</a>
          </code>
          <span class="show-leech"> from </span>
          <span class="show-seed"> to </span>
          <code id="numPeers">0 peers</code>.
        </div>
        <div>
          <code id="downloaded"></code>
          of <code id="total"></code>
          — <span id="remaining"></span><br/>
          &#x2198;<code id="downloadSpeed">0 b/s</code>
          / &#x2197;<code id="uploadSpeed">0 b/s</code>
        </div>
      </div>
    </div>
    <!-- Include the latest version of WebTorrent -->
    <script src="https://cdn.jsdelivr.net/npm/webtorrent@0.107.17/webtorrent.min.js"></script>

    <!-- Moment is used to show a human-readable remaining time -->
    <script src="http://momentjs.com/downloads/moment.min.js"></script>

    <script>
const PROXY_URL = 'https://cors-anywhere.herokuapp.com/';
const torrentId = PROXY_URL + 'https://webtorrent.io/torrents/sintel.torrent';

const client = new WebTorrent({ wssServers: [] });

const trackers = [
  'udp://tracker.openbittorrent.com:80',
  'udp://tracker.publicbt.com:80',
  'udp://tracker.internetwarriors.net:1337',
  'udp://tracker.opentrackr.org:1337/announce',
  'udp://explodie.org:6969/announce',
  'udp://9.rarbg.to:2710/announce',
  'udp://9.rarbg.me:2710/announce',
  'udp://exodus.desync.com:6969/announce',
];

// HTML elements
const $body = document.body;
const $progressBar = document.querySelector('#progressBar');
const $numPeers = document.querySelector('#numPeers');
const $downloaded = document.querySelector('#downloaded');
const $total = document.querySelector('#total');
const $remaining = document.querySelector('#remaining');
const $uploadSpeed = document.querySelector('#uploadSpeed');
const $downloadSpeed = document.querySelector('#downloadSpeed');

WebTorrent.DEBUG = true;

const torrentTitle = '[Erai-raws] One Piece - 1101 [480p] [ENG]';
const torrentLink = document.getElementById('torrentLink');
torrentLink.href = 'https://nyaa.si/download/1807247.torrent';
torrentLink.textContent = `${torrentTitle}.torrent`;

// Download the torrent
client.add(torrentId, { trackers }, function (torrent) {
  // Torrents can contain many files. Let's use the .mp4 or .mkv file
  const videoFile = torrent.files.find(function (file) {
    return file.name.endsWith('.mp4') || file.name.endsWith('.mkv');
  });

  // Find subtitle file (if any)
  const subtitleFile = torrent.files.find(function (file) {
    return file.name.endsWith('.vtt') || file.name.endsWith('.srt');
  });

  if (videoFile) {
    videoFile.appendTo('#output');

    if (subtitleFile) {
      // Add subtitle track
      const track = videoFile.renderingFor('video').addRemoteTextTrack({
        kind: 'subtitles',
        label: 'English',
        language: 'en',
        file: subtitleFile.getBlob(),
        mode: 'showing'
      });
    }

    // Trigger statistics refresh
    torrent.on('done', onDone);
    setInterval(onProgress, 500);
    onProgress();
  } else {
    console.error('Nenhum arquivo de vídeo encontrado no torrent.');
  }

  // Statistics
  function onProgress() {
    // Peers
    $numPeers.innerHTML = torrent.numPeers + (torrent.numPeers === 1 ? ' peer' : ' peers');

    // Progress
    const percent = Math.round(torrent.progress * 100 * 100) / 100;
    $progressBar.style.width = percent + '%';
    $downloaded.innerHTML = prettyBytes(torrent.downloaded);
    $total.innerHTML = prettyBytes(torrent.length);

    // Remaining time
    let remaining;
    if (torrent.done) {
      remaining = 'Done.';
    } else {
      remaining = moment.duration(torrent.timeRemaining / 1000, 'seconds').humanize();
      remaining = `${remaining[0].toUpperCase()}${remaining.substring(1)} remaining.`;
    }
    $remaining.innerHTML = remaining;

    // Speed rates
    $downloadSpeed.innerHTML = `${prettyBytes(torrent.downloadSpeed)}/s`;
    $uploadSpeed.innerHTML = `${prettyBytes(torrent.uploadSpeed)}/s`;
  }

  function onDone() {
    $body.className += ' is-seed';
    onProgress();
  }
});

// Human readable bytes util
function prettyBytes(num) {
  const units = ['B', 'kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
  const neg = num < 0;
  if (neg) num = -num;
  if (num < 1) return `${neg ? '-' : ''}${num} B`;
  const exponent = Math.min(Math.floor(Math.log(num) / Math.log(1000)), units.length - 1);
  const unit = units[exponent];
  num = Number((num / Math.pow(1000, exponent)).toFixed(2));
  return `${neg ? '-' : ''}${num} ${unit}`;
}
    </script>
  </body>
</html>