<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Equipamentos - D&D 5e</title>
  <style>
    :root {
      --primary-color: #7b2cbf;
      --secondary-color: #e0aaff;
      --dark-color: #240046;
      --light-color: #f8f9fa;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      background-color: #f5f5f5;
      background-image: url('https://www.transparenttextures.com/patterns/parchment.png');
      color: #333;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: var(--dark-color);
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .header p {
      font-size: 1.2rem;
      color: #666;
    }
    
    .character-info {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 30px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }
    
    .character-details {
      flex: 1;
      min-width: 300px;
    }
    
    .character-name {
      font-size: 1.8rem;
      color: var(--primary-color);
      margin-bottom: 5px;
    }
    
    .character-subtitle {
      font-size: 1.2rem;
      color: #666;
      margin-bottom: 10px;
    }
    
    .character-stats {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 10px;
    }
    
    .stat-item {
      background-color: var(--light-color);
      border-radius: 5px;
      padding: 8px 15px;
      font-weight: bold;
    }
    
    .stat-label {
      font-size: 0.8rem;
      color: #666;
      display: block;
    }
    
    .stat-value {
      font-size: 1.1rem;
      color: var(--dark-color);
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--dark-color);
    }
    
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    
    .tabs {
      display: flex;
      border-bottom: 2px solid var(--primary-color);
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background-color: #f1f1f1;
      border-top-left-radius: 5px;
      border-top-right-radius: 5px;
      margin-right: 5px;
      transition: all 0.3s ease;
    }
    
    .tab.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    .tab:hover:not(.active) {
      background-color: var(--secondary-color);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .equipment-section {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .section-title {
      color: var(--dark-color);
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    
    .equipment-group {
      margin-bottom: 25px;
    }
    
    .group-title {
      font-size: 1.3rem;
      color: var(--primary-color);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }
    
    .equipment-list {
      list-style: none;
    }
    
    .equipment-item {
      background-color: #f9f9f9;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid #ddd;
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .equipment-item:hover {
      transform: translateX(5px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .equipment-item.weapon {
      border-left-color: #dc3545;
    }
    
    .equipment-item.armor {
      border-left-color: #007bff;
    }
    
    .equipment-item.gear {
      border-left-color: #28a745;
    }
    
    .equipment-item.magic {
      border-left-color: #9932cc;
    }
    
    .equipment-name {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 5px;
    }
    
    .equipment-description {
      margin-top: 5px;
      font-size: 0.95rem;
      color: #666;
    }
    
    .equipment-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 5px;
      font-size: 0.9rem;
    }
    
    .equipment-meta-item {
      background-color: #eee;
      padding: 3px 8px;
      border-radius: 5px;
    }
    
    .equipment-actions {
      display: flex;
      gap: 10px;
    }
    
    .equipment-button {
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .equip-button {
      background-color: var(--success-color);
      color: white;
    }
    
    .equip-button:hover {
      background-color: #218838;
    }
    
    .unequip-button {
      background-color: var(--danger-color);
      color: white;
    }
    
    .unequip-button:hover {
      background-color: #c82333;
    }
    
    .coins-section {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .coins-container {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    
    .coin-item {
      text-align: center;
      padding: 15px;
      border-radius: 10px;
      min-width: 120px;
    }
    
    .coin-copper {
      background-color: #cd7f32;
      color: white;
    }
    
    .coin-silver {
      background-color: #c0c0c0;
      color: #333;
    }
    
    .coin-gold {
      background-color: #ffd700;
      color: #333;
    }
    
    .coin-value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .coin-label {
      font-size: 0.9rem;
    }
    
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .hidden {
      display: none;
    }
    
    .empty-message {
      text-align: center;
      padding: 30px;
      color: #666;
      font-style: italic;
    }
    
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: var(--primary-color);
      text-decoration: none;
      font-weight: bold;
    }
    
    .back-link:hover {
      text-decoration: underline;
    }
    
    .shop-section {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .shop-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .shop-item {
      background-color: #f9f9f9;
      border-radius: 5px;
      padding: 15px;
      border: 1px solid #ddd;
      transition: all 0.3s ease;
    }
    
    .shop-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .shop-item-name {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 5px;
      color: var(--dark-color);
    }
    
    .shop-item-description {
      margin-top: 5px;
      font-size: 0.95rem;
      color: #666;
      margin-bottom: 10px;
    }
    
    .shop-item-price {
      font-weight: bold;
      color: #b8860b;
      margin-bottom: 10px;
    }
    
    .buy-button {
      width: 100%;
      padding: 8px;
      background-color: var(--success-color);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .buy-button:hover {
      background-color: #218838;
    }
    
    .buy-button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    
    @media (max-width: 768px) {
      .character-info {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .character-stats {
        margin-top: 15px;
      }
      
      .tabs {
        flex-wrap: wrap;
      }
      
      .tab {
        flex: 1;
        text-align: center;
        min-width: 120px;
        margin-bottom: 5px;
      }
      
      .equipment-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .equipment-actions {
        margin-top: 10px;
        width: 100%;
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="personagem.html" class="back-link">‚Üê Voltar para Ficha de Personagem</a>
    
    <div class="header">
      <h1>Equipamentos</h1>
      <p>Gerencie os equipamentos, armas e itens do seu personagem</p>
    </div>
    
    <div id="character-info" class="character-info">
      <div class="character-details">
        <h2 id="character-name" class="character-name">Carregando...</h2>
        <div id="character-subtitle" class="character-subtitle"></div>
      </div>
      
      <div class="character-stats">
        <div class="stat-item">
          <span class="stat-label">N√≠vel</span>
          <span id="character-level" class="stat-value">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Classe</span>
          <span id="character-class" class="stat-value">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Ra√ßa</span>
          <span id="character-race" class="stat-value">-</span>
        </div>
      </div>
    </div>
    
    <div class="coins-section">
      <h2 class="section-title">Moedas</h2>
      <div class="coins-container">
        <div class="coin-item coin-copper">
          <div id="copper-value" class="coin-value">0</div>
          <div class="coin-label">Cobre (PC)</div>
        </div>
        <div class="coin-item coin-silver">
          <div id="silver-value" class="coin-value">0</div>
          <div class="coin-label">Prata (PP)</div>
        </div>
        <div class="coin-item coin-gold">
          <div id="gold-value" class="coin-value">0</div>
          <div class="coin-label">Ouro (PO)</div>
        </div>
      </div>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-tab="inventory">Invent√°rio</div>
      <div class="tab" data-tab="equipped">Equipados</div>
      <div class="tab" data-tab="shop">Loja</div>
    </div>
    
    <div id="inventory-tab" class="tab-content active">
      <div class="equipment-section">
        <h2 class="section-title">Invent√°rio</h2>
        <div id="inventory-container">
          <p class="empty-message">Carregando invent√°rio...</p>
        </div>
      </div>
    </div>
    
    <div id="equipped-tab" class="tab-content">
      <div class="equipment-section">
        <h2 class="section-title">Equipamentos Equipados</h2>
        <div id="equipped-container">
          <p class="empty-message">Carregando equipamentos...</p>
        </div>
      </div>
    </div>
    
    <div id="shop-tab" class="tab-content">
      <div class="shop-section">
        <h2 class="section-title">Loja de Equipamentos</h2>
        <p>Compre novos equipamentos, armas e itens para seu personagem.</p>
        <div id="shop-container" class="shop-items">
          <!-- Conte√∫do da loja ser√° carregado aqui -->
          <p class="empty-message">Carregando loja...</p>
        </div>
      </div>
    </div> <!-- Fim de #shop-tab -->

  </div> <!-- Fim de .container -->

  <script>
    // Fun√ß√£o para configurar as abas
    function setupTabs() {
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Remover classe active de todas as abas e conte√∫dos
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));

          // Adicionar classe active √† aba clicada e ao seu conte√∫do
          tab.classList.add('active');
          const targetTabContent = document.getElementById(`${tab.dataset.tab}-tab`);
          if (targetTabContent) {
            targetTabContent.classList.add('active');
          } else {
            console.error(`Conte√∫do da aba n√£o encontrado para: ${tab.dataset.tab}-tab`);
          }
        });
      });
    }

    // Fun√ß√£o para carregar equipamentos gerais (Invent√°rio)
    function loadGeneralEquipment(character) {
      const container = document.getElementById('general-equipment-list');
      if (!container) return;
      
      container.innerHTML = '';
      
      if (!character.equipment || !Array.isArray(character.equipment) || character.equipment.length === 0) {
        container.innerHTML = '<p>Nenhum item no invent√°rio.</p>';
        return;
      }

      // Agrupar itens id√™nticos
      const groupedItems = {};
      
      character.equipment.forEach(item => {
        const itemName = typeof item === 'object' ? item.name : item;
        
        if (groupedItems[itemName]) {
          groupedItems[itemName].quantity += 1;
        } else {
          groupedItems[itemName] = {
            item: item, // Guardar o item completo (objeto ou string)
            quantity: 1
          };
        }
      });
      
      // Criar elementos HTML para cada grupo de itens
      Object.values(groupedItems).forEach(group => {
        const item = group.item;
        const quantity = group.quantity;
        const itemName = typeof item === 'object' ? item.name : item;
        
        const itemElement = document.createElement('div');
        itemElement.className = 'equipment-item';
        
        // Mostrar descri√ß√£o detalhada para itens objetos, descri√ß√£o simples para strings
        let itemDescription = '';
        if (typeof item === 'object') {
          if (item.description) {
            itemDescription = item.description;
          } else if (item.damage) {
            itemDescription = `Dano: ${item.damage} ${item.damageType || ''}`;
            if (item.properties) {
              itemDescription += `, Propriedades: ${item.properties}`;
            }
          }
        } else {
          // Para itens string, voc√™ pode ter um mapeamento ou deixar simples
          itemDescription = 'Item no invent√°rio';
        }
        
        // Montar o HTML do item com quantidade para itens agrupados
        itemElement.innerHTML = `
          <div class="item-name">${itemName}${quantity > 1 ? ` (x${quantity})` : ''}</div>
          <div class="item-description">${itemDescription}</div>
          <button class="equip-button" data-item-name="${encodeURIComponent(itemName)}">Equipar</button>
          <button class="drop-button" data-item-name="${encodeURIComponent(itemName)}">Largar</button>
          ${isUsableItem(itemName) ? `<button class="use-button" data-item-name="${encodeURIComponent(itemName)}">Usar</button>` : ''}
        `;
        
        container.appendChild(itemElement);
      });
      
      // Adicionar event listeners para os bot√µes
      container.querySelectorAll('.equip-button').forEach(button => {
        button.addEventListener('click', function() {
          const itemName = decodeURIComponent(this.dataset.itemName);
          equipItem(itemName, character);
        });
      });
      
      container.querySelectorAll('.drop-button').forEach(button => {
        button.addEventListener('click', function() {
          const itemName = decodeURIComponent(this.dataset.itemName);
          dropItem(itemName, character);
        });
      });
      
      // Event listeners para bot√µes Usar (se existirem)
      container.querySelectorAll('.use-button').forEach(button => {
        button.addEventListener('click', function() {
          const itemName = decodeURIComponent(this.dataset.itemName);
          useItem(itemName, character);
        });
      });
    }

    // Fun√ß√£o para carregar equipamentos equipados
    function loadEquippedItems(character) {
      const container = document.getElementById('equipped-container');
       if (!container) {
        console.error('Container de equipados (equipped-container) n√£o encontrado');
        return;
      }
      container.innerHTML = ''; // Limpar container

      const items = (character.equipped || []).filter(item => item && typeof item === 'string');

      if (items.length === 0) {
        container.innerHTML = '<p class="empty-message">Voc√™ n√£o tem nenhum item equipado.</p>';
        return;
      }

      items.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'equipment-item equipped';
        itemElement.innerHTML = `
          <div class="equipment-details">
            <div class="equipment-name">${item}</div>
            <div class="equipment-description">Item equipado</div>
          </div>
          <div class="equipment-actions">
            <button class="equipment-button unequip-button" data-item="${encodeURIComponent(item)}">Desequipar</button>
          </div>
        `;
        container.appendChild(itemElement);
      });

      // Adicionar listeners para bot√µes de desequipar
      container.querySelectorAll('.unequip-button').forEach(button => {
        button.addEventListener('click', function() {
          const item = decodeURIComponent(this.dataset.item);
          unequipItem(item, character);
        });
      });
    }

    // Fun√ß√£o para equipar um item
    function equipItem(itemName, character) {
      if (!character.equipment || !Array.isArray(character.equipment)) {
        character.equipment = [];
      }
      
      if (!character.equipped || !Array.isArray(character.equipped)) {
        character.equipped = [];
      }
      
      // Verificar se o item existe no invent√°rio
      const itemIndex = findItemIndex(itemName, character.equipment);
      
      if (itemIndex !== -1) {
        // Encontrou o item - obter o item real (pode ser objeto ou string)
        const item = character.equipment[itemIndex];
        
        // Remover uma unidade do invent√°rio
        character.equipment.splice(itemIndex, 1);
        
        // Adicionar aos equipados
        character.equipped.push(item);
        
        // Salvar personagem atualizado
        localStorage.setItem('currentCharacter', JSON.stringify(character));
        
        // Recarregar listas
        loadGeneralEquipment(character);
        loadEquippedItems(character);
      } else {
        console.warn(`Tentativa de equipar item n√£o encontrado no invent√°rio: ${itemName}`);
      }
    }

    // Fun√ß√£o para desequipar um item
    function unequipItem(itemName, character) {
      if (!character.equipped || !Array.isArray(character.equipped)) {
        character.equipped = [];
      }
      
      if (!character.equipment || !Array.isArray(character.equipment)) {
        character.equipment = [];
      }
      
      // Verificar se o item existe nos equipados
      const itemIndex = findItemIndex(itemName, character.equipped);
      
      if (itemIndex !== -1) {
        // Encontrou o item - obter o item real
        const item = character.equipped[itemIndex];
        
        // Remover dos equipados
        character.equipped.splice(itemIndex, 1);
        
        // Adicionar ao invent√°rio
        character.equipment.push(item);
        
        // Salvar personagem atualizado
        localStorage.setItem('currentCharacter', JSON.stringify(character));
        
        // Recarregar listas
        loadGeneralEquipment(character);
        loadEquippedItems(character);
      } else {
        console.warn(`Tentativa de desequipar item n√£o encontrado nos equipados: ${itemName}`);
      }
    }

    // Fun√ß√£o para normalizar moedas (converter moedas menores em maiores quando poss√≠vel)
    function normalizeCurrency(character) {
      if (!character) return;
      
      // Converter tudo para cobre primeiro
      let totalCopper = (character.copper || 0) + 
                       (character.silver || 0) * 10 + 
                       (character.gold || 0) * 100;
      
      // Recalcular
      character.gold = Math.floor(totalCopper / 100);
      totalCopper %= 100;
      character.silver = Math.floor(totalCopper / 10);
      character.copper = totalCopper % 10;
      
      console.log(`Moedas normalizadas: G:${character.gold}, S:${character.silver}, C:${character.copper}`);
      return character;
    }

    // Fun√ß√£o principal para carregar a p√°gina de equipamentos
    function loadEquipmentPage() {
      try {
        const characterData = localStorage.getItem('currentCharacter');
        if (!characterData) {
          alert('Nenhum personagem encontrado. Volte para a ficha de personagem.');
          window.location.href = 'personagem.html';
          return;
        }

        const character = JSON.parse(characterData);
        console.log("Personagem carregado:", character);

        // Normalizar moedas antes de exibir
        normalizeCurrency(character);

        // Selecionar elementos
        const charNameEl = document.getElementById('character-name');
        const charSubtitleEl = document.getElementById('character-subtitle');
        const charLevelEl = document.getElementById('character-level');
        const charClassEl = document.getElementById('character-class');
        const charRaceEl = document.getElementById('character-race');
        const copperValueEl = document.getElementById('copper-value');
        const silverValueEl = document.getElementById('silver-value');
        const goldValueEl = document.getElementById('gold-value');

        // Atualizar informa√ß√µes b√°sicas (com verifica√ß√µes)
        if (charNameEl) charNameEl.textContent = character.name || "Sem Nome";
        if (charSubtitleEl) charSubtitleEl.textContent = `${character.race || "Desconhecida"} ${character.class || "Desconhecida"}`;
        if (charLevelEl) charLevelEl.textContent = character.level || 1;
        if (charClassEl) charClassEl.textContent = character.class || "Desconhecida";
        if (charRaceEl) charRaceEl.textContent = character.race || "Desconhecida";

        // Atualizar moedas (com verifica√ß√µes)
        if (copperValueEl) copperValueEl.textContent = character.copper || 0;
        if (silverValueEl) silverValueEl.textContent = character.silver || 0;
        if (goldValueEl) goldValueEl.textContent = character.gold || 0;

        // Carregar listas de equipamentos
        loadGeneralEquipment(character);
        loadEquippedItems(character);
        loadShopItems(); // <<< IS THIS LINE PRESENT AND UNCOMMENTED?

        // Configurar abas
        setupTabs();

      } catch (error) {
        console.error("Erro ao carregar equipamentos:", error);
        alert(`Ocorreu um erro ao carregar os equipamentos: ${error.message}`);
      }
    }

    // Inicializar a p√°gina quando o documento estiver carregado
    document.addEventListener('DOMContentLoaded', loadEquipmentPage);

    // REMOVIDO: O setTimeout para #return-btn n√£o pertence a esta p√°gina
    // setTimeout(() => { ... }, 100);

    // Example Shop Items (replace with your actual items)
    const shopInventory = [
      { name: "Po√ß√£o de Cura", type: "potion", price: 50, currency: "gold", description: "Restaura 2d4+2 pontos de vida." },
      { name: "Espada Curta", type: "weapon", price: 10, currency: "gold", description: "Dano 1d6 perfurante, leve, acuidade." },
      { name: "Escudo", type: "armor", price: 10, currency: "gold", description: "+2 CA." },
      { name: "Ra√ß√µes (1 dia)", type: "gear", price: 5, currency: "silver", description: "Comida e √°gua para um dia." }
    ];

    function loadShopItems() {
      const container = document.getElementById('shop-container');
      if (!container) {
        console.error('Container da loja (shop-container) n√£o encontrado');
        return;
      }
      container.innerHTML = ''; // Limpar "Carregando..."

      if (!shopInventory || shopInventory.length === 0) {
        container.innerHTML = '<p class="empty-message">A loja est√° vazia no momento.</p>';
        return;
      }

      shopInventory.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'shop-item'; // Use a classe CSS definida
        itemElement.innerHTML = `
          <div class="shop-item-name">${item.name}</div>
          <div class="shop-item-description">${item.description}</div>
          <div class="shop-item-price">Pre√ßo: ${item.price} ${item.currency === 'gold' ? 'PO' : (item.currency === 'silver' ? 'PP' : 'PC')}</div>
          <button class="buy-button" data-item-name="${encodeURIComponent(item.name)}">Comprar</button>
        `;
        container.appendChild(itemElement);
      });

      // Add event listeners for buy buttons (implement buyItem function)
      container.querySelectorAll('.buy-button').forEach(button => {
        button.addEventListener('click', function() {
          const itemName = decodeURIComponent(this.dataset.itemName);
          // Find the item object from shopInventory if needed
          const itemToBuy = shopInventory.find(i => i.name === itemName);
          if (itemToBuy) {
             buyItem(itemToBuy); // Implement buyItem function
          }
        });
      });
    }

    // Fun√ß√£o para comprar um item da loja
    function buyItem(itemToBuy) {
      console.log("Tentando comprar:", itemToBuy.name);
      
      // Recuperar personagem atual do localStorage
      const characterData = localStorage.getItem('currentCharacter');
      if (!characterData) {
        alert('Nenhum personagem encontrado. Por favor, crie um personagem primeiro.');
        return;
      }
      
      const character = JSON.parse(characterData);
      
      // Verificar se o personagem tem moedas suficientes
      let totalCopper = (character.copper || 0);
      let totalSilver = (character.silver || 0) * 10; // Converter para cobre
      let totalGold = (character.gold || 0) * 100;    // Converter para cobre
      
      let totalAvailable = totalCopper + totalSilver + totalGold;
      
      // Converter pre√ßo do item para cobre
      let itemPriceInCopper;
      if (itemToBuy.currency === 'gold') {
        itemPriceInCopper = itemToBuy.price * 100;
      } else if (itemToBuy.currency === 'silver') {
        itemPriceInCopper = itemToBuy.price * 10;
      } else {
        itemPriceInCopper = itemToBuy.price;
      }
      
      if (totalAvailable < itemPriceInCopper) {
        alert(`Voc√™ n√£o tem moedas suficientes para comprar ${itemToBuy.name}!`);
        return;
      }
      
      // Subtrair o pre√ßo do total de moedas
      totalAvailable -= itemPriceInCopper;
      
      // Recalcular moedas
      character.gold = Math.floor(totalAvailable / 100);
      totalAvailable %= 100;
      character.silver = Math.floor(totalAvailable / 10);
      totalAvailable %= 10;
      character.copper = totalAvailable;
      
      // Adicionar item ao invent√°rio
      if (!character.equipment) {
        character.equipment = [];
      }
      
      character.equipment.push(itemToBuy.name);
      
      // Salvar personagem atualizado
      localStorage.setItem('currentCharacter', JSON.stringify(character));
      
      // Atualizar exibi√ß√£o
      loadGeneralEquipment(character);
      updateCoinDisplay(character);
      
      alert(`Voc√™ comprou ${itemToBuy.name} por ${itemToBuy.price} ${itemToBuy.currency === 'gold' ? 'PO' : (itemToBuy.currency === 'silver' ? 'PP' : 'PC')}`);
    }

    // Exemplo de defini√ß√£o de item
    const chainMail = { name: "Chain Mail", type: "armor", category: "heavy", ac: 16, strength_requirement: 13 };
    const shield = { name: "Escudo", type: "armor", category: "shield", ac_bonus: 2 };

    // Fun√ß√£o para verificar se um item pode ser usado
    function isUsableItem(itemName) {
      const usableItems = [
        'Po√ß√£o de Cura', 
        'Pergaminho de Identifica√ß√£o',
        'Bolsa com 10 pe√ßas de ouro',
        'Po√ß√£o de Invisibilidade',
        'Po√ß√£o de For√ßa',
        'Pergaminho de Magia'
      ];
      
      return usableItems.some(usable => itemName.includes(usable));
    }

    // Fun√ß√£o para usar um item
    function useItem(itemName, character) {
      console.log(`Usando item: ${itemName}`);
      
      if (itemName === 'Po√ß√£o de Cura') {
        // Restaurar pontos de vida
        const cura = Math.floor(Math.random() * 8) + 1 + 1; // 1d8+1
        character.hp_current = Math.min(character.hp_max, character.hp_current + cura);
        alert(`Voc√™ usou uma Po√ß√£o de Cura e recuperou ${cura} pontos de vida!`);
        
        // Remover um item do invent√°rio
        removeItemFromInventory(itemName, character, 1);
        localStorage.setItem('currentCharacter', JSON.stringify(character));
        loadGeneralEquipment(character);
        
      } else if (itemName === 'Pergaminho de Identifica√ß√£o') {
        alert("Voc√™ usa o pergaminho, mas n√£o h√° itens n√£o identificados no seu invent√°rio.");
        
        // Remover um item do invent√°rio
        removeItemFromInventory(itemName, character, 1);
        localStorage.setItem('currentCharacter', JSON.stringify(character));
        loadGeneralEquipment(character);
        
      } else if (itemName === 'Bolsa com 10 pe√ßas de ouro') {
        // Adicionar moedas ao personagem
        character.gold = (character.gold || 0) + 10;
        alert("Voc√™ abriu a bolsa e adicionou 10 pe√ßas de ouro ao seu invent√°rio!");
        
        // Remover item do invent√°rio
        removeItemFromInventory(itemName, character, 1);
        localStorage.setItem('currentCharacter', JSON.stringify(character));
        loadGeneralEquipment(character);
        
        // Atualizar exibi√ß√£o de moedas
        updateCoinDisplay(character);
      } else {
        alert(`Voc√™ tentou usar ${itemName}, mas n√£o aconteceu nada de especial.`);
      }
    }

    // Fun√ß√£o para atualizar display de moedas
    function updateCoinDisplay(character) {
      const copperEl = document.getElementById('copper-value');
      const silverEl = document.getElementById('silver-value');
      const goldEl = document.getElementById('gold-value');
      
      if (copperEl) copperEl.textContent = character.copper || 0;
      if (silverEl) silverEl.textContent = character.silver || 0;
      if (goldEl) goldEl.textContent = character.gold || 0;
    }

    // Fun√ß√£o para remover uma quantidade de itens do invent√°rio
    function removeItemFromInventory(itemName, character, quantity) {
      if (!character.equipment || !Array.isArray(character.equipment)) return;
      
      let removed = 0;
      for (let i = character.equipment.length - 1; i >= 0; i--) {
        const currentItem = character.equipment[i];
        const currentItemName = typeof currentItem === 'object' ? currentItem.name : currentItem;
        
        if (currentItemName === itemName && removed < quantity) {
          character.equipment.splice(i, 1);
          removed++;
          if (removed >= quantity) break;
        }
      }
    }

    // Fun√ß√£o auxiliar para encontrar o √≠ndice de um item por nome
    function findItemIndex(itemName, itemArray) {
      if (!itemArray || !Array.isArray(itemArray)) return -1;
      
      return itemArray.findIndex(item => {
        const currentItemName = typeof item === 'object' ? item.name : item;
        return currentItemName === itemName;
      });
    }
  </script>
</body>
</html>
